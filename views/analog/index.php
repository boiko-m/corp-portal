<?php

$json = '
{"items":[[{"value":"Наименование товара"},{"value":""},{"value":"RCW 10 000 Разбрасыватель"},{"value":"MX - 3000 на шасси KASTOR PR – 02"}],[{"value":"Производитель"},{"value":""},{"value":"AGROMET PILMET"},{"value":"AGROMET PILMET"}],[{"value":"Изображение"},{"value":""},{"value":"","params": {
     "image": "MNS0092586/UPR-00620244_Haulotte.jpg"
 }},{"value":""}],[{"value":"Ширина внесения, м","params":{"info":"От ширины внесения зависит производительность техники, площадь обработки и агротехнические сроки внесения удобрений. На рынке существуют модели с шириной внесения от 8 до 48 м,"}},{"value":"больше ширина внесения - выше производительность, ниже расход топлива"},{"value":"гранулированные удобрения: 10-36  пылевидные: 8-16"},{"value":"10-36"}],[{"value":"Производительность, га/ч","params":{"info":"С производительностью от 6,5 до 55 га/ч. Производительность должна позволять внести удобрения на нужные посевные площади за агросрок."}},{"value":""},{"value":"Граждане, весна оттрубила свое, тем не менее задав старт высокому отпускному сезону. Настала пора поставить на паузу свои перенапрягшиеся нервы, мозг и тело и заслуженно отдохнуть. В большинстве своем белорусское народонаселение ассоциирует отпуск с заграницей, к которой желательно прикрученное море с пляжем. Но есть и любители другого вида релакса."},{"value":"до 40"}],[{"value":"Объем вместимости, м.куб","params":{"info":"Объем вместимости позволяет обработать большую площадь без дополнительных дозаправок удобрениями, за счет чего экономится ГСМ. Меньше холостых перездов, что увеличивает обрабатываемые площади в агросрок. Прицепные разбрасыватели бывают от 1,6 до 12 м.куб"}},{"value":"больше бункер - меньше остановок на заправку, больше выработка в смену"},{"value":"10"},{"value":"3"}],[{"value":"Тип транспортера","params":{"info":"Транспортер разбрасывателя точно доставляет материал на диски разбрасывателя, ленточный не нарушает целостность гранулированных удобрений. Равномерно подает удобрения. Дольше служит. Бывают цепные и ленточные транспортеры. Цепные - способны повредить удобрения при подаче на диски, подача не равномерная. Цепные подвержены коррозии при контакте с удобрениями."}},{"value":"Ленточные лучше цепных, не повреждают гранулы удобрений"},{"value":"ленточный"},{"value":"ворошилка"}],[{"value":"Количество разбрасывающих тарелок","params":{"info":"Под каждый вид удобрений целесообразно использовать определенную размерность разбрасывающих тарелок для обеспечения точности и равномерности внесения и максимальной производительности. Обработка по краю поля намного проще при наличии крайнего диска, экономятся удобрения. На рынке существуют разбрасыватели с 1 комплектом тарелок, без крайнего диска."}},{"value":""},{"value":"2 для гранул, 2 для извести и 1 крайний диск"},{"value":"2"}],[{"value":"Диапазон регулировки дозирующего отверстия","params":{"info":"Регулировка отверстия позволяет увеличивать или уменьшать дозу внесения, а также использовать разбрасыватель для посева зерновых или обработки дорог песком или солью. Широкий диапазон обеспечивает многофункциональность разбрасывателя."}},{"value":"Широкий диапазон нужен для  разных материалов (соль, песок, известь, минеральные убобрения, зерно)"},{"value":"0-250 мм"},{"value":""}],[{"value":"Число колес, шины","params":{"info":"На объем бункера свыше 9 м.куб целесообразно использовать двухосную модель, либо одноосную с большими колесами низкого давления -  для большей устойчивости и проходимости. Меньшее давление на почву, позволяет входить в переувлажненное поле и осуществить внесение удобрений в более ранние сроки."}},{"value":"Широкие колеса и несколько осей - не вязнет во влажной почве, растягиваем агросрок внесения."},{"value":"4 шт, 500 / 60–22,5"},{"value":"2 шт, 400 / 60–15,5"}],[{"value":"Габаритные размеры","params":{"info":"Габаритные размеры разбрасывателя влияют на возможность производить транспортировку по дорогам общего пользования, например для внесения песка и соли на дорожное полотно. На рынке существуют разбрасыватели свыше 2,6м в ширину - неудобны для транспортировки в стандартавто."}},{"value":""},{"value":"6,8х2,35х2,56"},{"value":"2,5х2,7х2,5"}],[{"value":"Масса, кг","params":{"info":"Легкий собственный вес при большой грузоподъемности позволяет агрегатироваться с тракторами меньшей мощности. Мощность трактора тратится не на перевозку прицепа ,а груза. экономится ГСМ, Меньшее давление на почву, позволяет входить в переувлажненное поле и осуществить внесение удобрений в более ранние сроки. На рынке существуют разбрасыватели свыше от 4 до 5 и более тонн собственной массы"}},{"value":""},{"value":"3960"},{"value":"950"}],[{"value":"Агрегатируется с трактором, л.с.","params":{"info":"Прицепные разбрасыватели имея большой объем вместимости способны эксплуатироваться с тракторами меньшей мощности, как вывод - экономия ГСМ при увеличенной производительности. На рынке существуют разбрасыватели, которые агрегатируются с тракторами от 150 л.с. - имея аналогичный объем вместимости (за счет собственной массы прицепа)"}},{"value":""},{"value":"от 110"},{"value":"от 60"}],[{"value":"Привод напольного транспортера","params":{"info":"Напольный транспортер может приводиться в действие либо от гидравлики трактора, либо механически - от шпорного колеса. Ленточный транспортер подает удобрения на разбрасывающие диски. При работе шпорного колеса - подача осуществляется только при движении разбрасывателя по полю"}},{"value":"Шпоровое колесо - работает без компьютера; гидравлика только через дорогой компьютер и датчики."},{"value":"шпорное колесо (опция гидравлика)"},{"value":"нет"}],[{"value":"Многофункциональность","params":{"info":"Отличным показателем разбрасывателя удобрений является его многофункциональность, чтобы по максимуму использовать его на протяжении года, а не только в период внесения удобрений."}},{"value":""},{"value":"гранулы, порошковые, посев зерна,песок,соль,навоз"},{"value":"гранул. удобрения, зерно, песок, соль"}],[{"value":"Тормозная система","params":{"info":"Внесение удобрений производится на скорости до 12 км/ч, поля могут быть с уклонами. Наличие тормозной системы является необходимым в вышеуказанных условиях. Работа с прицепом без тормозной системе на склонах приводит к повышенной нагрузке на трактор, а в некоторых случаях внесение удобрений невозможно."}},{"value":""},{"value":"1-пр. пневматическая система + ручной тормоз"},{"value":"нет"}],[{"value":"Сито для загрузки в бункер","params":{"info":"Установка сита не допускает поподания в бункер сторонних предметов, которые могут привести к поломке привода и дисков."}},{"value":""},{"value":"есть"},{"value":"да"}],[{"value":"Разбрасывающие диски","params":{"info":"Нержавеющая сталь не вступает в реакцию с минеральными удобрениями, долго сохраняет функициональность и не подвержена коррозии. На рынке имеются разбрасыватели с дисками из черного металла, окрашенные."}},{"value":""},{"value":"Из нержавеющей стали"},{"value":"Из нержавеющей стали"}],[{"value":"Компьютер","params":{"info":" поддержание заданной дозы удобрения или извести независимо от скорости движения, нанесение карты полей, передачи данных в отдоленный компьютер и т.д. Повышает урожайность и экономит удобрения."}},{"value":""},{"value":"Superior (опция)"},{"value":"нет"}],[{"value":"Тент","params":{"info":"Наличие тента позволяет вносить удобрения в плохих погодных условиях."}},{"value":""},{"value":"есть","params":{"video":"https://youtu.be/GEgP04blOZU","video_start":"317","video_stop":"327"}},{"value":"есть (опция)"}],[{"value":"Гарантия","params":{"info":"Гарантия производителя подтверждает надежность и качество техники. Большинство импортных разбрасывателей на рынке с гарантией 1 год"}},{"value":""},{"value":"2 года"},{"value":"2 года"}],[{"value":"Цена","params":{"info":"Экономия вложенных средств"}},{"value":""},{"value":"22000 евро в Смоленске"},{"value":"7500 евро"}]],"parameters":{"header":"Рекомендуем ознакомиться с техническими характеристиками товаров.","client":"Уважаемая Дворникова Татьяна Валериевна","user":"dushin         ","user_info":"Душин Игорь Анатольевич<br>Телефон: +375296086802<br>E-mail: dushin@lbr.ru<br>","user_guid":"bbaf2c3a-64b1-11e4-8582-005056a36ce0","filial":"SMK","email":"dushin@lbr.ru","print":"0"}}
';


class Analog
{
  public $items;
  public $value;
  public $attr;
  public $result;
  public $image;
  public $class;
  public $link;
  public $attr_link;
  function __construct($items)
  {

    $this->items = $items;



        foreach ($items as $item) {
          $this->result .= "<tr>";
          foreach ($item as $index => $cell) {
            $this->image = null;
            $this->value = $cell['value'];
            $this->attr = null;
            $this->attr_link = null;
            if ($cell['params']) {
              $this->params($cell['params']);
            } else {
              $this->params = null;
            }
            $addStyles = '';
            if($index == 0) {
                $addStyles = 'font-weight: bold;text-align:left;';
            } elseif($index == 1) {
                $addStyles = 'color:#007aa5;text-align:left;';
            }
            $this->result .= "<td style ='".$addStyles . $this->style."' class = '".$this->class."' ".$this->attr.">".$this->value.$this->image."</td>";
          }
          $this->result .= "</tr>";
        }

  }
  public function params($params) {
    foreach ($params as $key => $param) {
      $this->$key($param);
    }
  }
  public function image ($img) {
    $this->image = "<img src='http://api.lbr.ru/images/analog/".$img."' alt='' width=\"160\" style = 'width: 160px;'>";
    $this->style .= ";padding:0px;";
  }
  public function colspan ($colspan) {
    $this->attr .= " colspan = '0'";
  }
  public function info($info) {
    //$this->attr .= " title = '".$info."'";
    $this->class = "info_block";
    $this->value = " ".$this->value." <div style=' color: #555;font-size: 11px;text-align: justify;padding: 5px;border: 1px solid #dfdfdf;border-radius: 2px;margin: 5px 0;font-weight: 400;background: #f5f5f5;'>".$info."</div>";
  }
  public function video ($link) {
    $this->link = str_replace(array("https://youtu.be/", "https://www.youtube.com/watch?v="), "", $link);
    $this->attr_link = "?fs=1";
    $this->value = "<iframe class='ytplayer' width='208' height='150' src='http://www.youtube.com/embed/".$this->link."?".$this->attr_link."' frameborder='0' allowfullscreen></iframe>";
  }
  public function video_start($attr) {
    $this->attr_link .= "&start=".$attr;
    $this->value = "<iframe class='ytplayer' src='http://www.youtube.com/embed/".$this->link."?".$this->attr_link."' frameborder='0' allowfullscreen></iframe>";
  }
  public function video_stop($attr) {
    $this->attr_link .= "&end=".$attr;
    $this->value = "<iframe class='ytplayer' src='http://www.youtube.com/embed/".$this->link."?".$this->attr_link."' frameborder='0' allowfullscreen></iframe>";
  }
  public function result() {
    return $this->result;
  }


}


$request = Yii::$app->request;

if (!$request->post('json')) {
  $items = $json;
} else {
  $items = $request->post('json');
}


$items = json_decode($items, true);


$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'https://www.lbr.ru/api/getfilial/?code='.$items['parameters']['filial']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_USERPWD, "admin:qazplm123");
$filial = json_decode(curl_exec($ch), true);
curl_close($ch);
 ?>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <style>
        *{font-family:'Open Sans',Arial,Helvetica,Verdana,sans-serif!important}.analog-table{width:100%;background-color:#fff;border-collapse:collapse;empty-cells:show;font-size:15px}.analog-table td[colspan]{background:#f3f3f3}.analog-table td:first-child{padding:8px 5px;font-weight:700;width:20%;text-align:left;background:#f6f6f69e}.analog-table td:first-child:hover{background:#fff}.analog-table td{text-align:center;max-width:150px;padding:7px}.analog-table tr td:nth-child(2){color:#007aa5;text-align:left}.analog-table img{width:100%}.info_block_hidden{color:#555;font-size:11px;text-align:justify;padding:5px;border:1px solid #dfdfdf;border-radius:2px;margin:5px 0;font-weight:400;background:#f5f5f5}
        p{mso-line-height-rule: exactly !important; line-height: 13pt;}
        a, a:active, a:visited{color:black;}
        p{mso-line-height-rule:exactly !important; line-height: 13pt;}
        a, a:active, a:visited{color:black;}
    </style>
</head>
<body style="background: #eeeeee; margin: 0; padding: 0; border: 0;">

<!-- Background grey -->
<table style="background: #eeeeee; margin: 0; padding: 0; border: 0; width: 100%;">
    <tbody><tr>
        <td>
            <table width="100%" bgcolor="#eeeeee" cellspacing="0" cellpadding="0" align="center" style="border: 0; border-collapse: collapse;background-color: #eeeeee;">
                <tbody><tr>
                    <td>
                        <table width="100%" cellspacing="0" cellpadding="0" bgcolor="#FFFFFF" align="center" style="border: 0; border-collapse: collapse; background: white;">
                            <tbody>
                            <?if($items['parameters']['print'] == 0):?>
                            <tr>
                                <td style="padding: 0px 20px 20px 20px;">
                                    <table width="100%" cellspacing="0" cellpadding="0" bgcolor="white" align="center" style="border: 0; border-collapse: collapse; background: #ffffff;">
                                        <tbody><tr>
                                            <td width="120" style="padding: 20px 0px 0px 0px;" valign="top">
                                                                                                <a href="https://www.lbr.ru/?sb=video_m1&amp;ct=Z2F2cmlsZW5rb0BsYnIucnU7&amp;lk=56" title="Сайт ЛБР-агромаркет" style=" text-decoration: none; border: 0;" target="_blank">
                                                    <img src="https://www.lbr.ru/images/evp_template/logo-new.jpg" width="100" style="border: 0; float: left;" alt="Логотип ЛБР-Агромаркет">
                                                </a>
                                            </td>
                                            <td width="640" style="padding: 20px 0px 0px 10px; text-align: left;" valign="top">
                                                <span style="margin: 0; padding: 0; color: #000000; background: none !important; font-size: 13px; font-weight: normal; font-family: Verdana, Arial, Arial Narrow, Helvetica,sans-serif; outline: none;">
                                                    <?php echo $items['parameters']['header']?>                                                </span>
                                            </td>
                                        </tr>
                                    </tbody></table>
                                </td>
                            </tr>
                            <?endif;?>
                            <tr>
                                <td style="padding: 0px 20px 0px 20px;">
                                    <table class="analog-table" cellspacing="0" cellpadding="0" border="1" bordercolor = "#cccccc">
                                      <tr>
                                        <td style="text-align:left; font-weight: bold;">Характеристика:</td>
                                        <td style="color:#007aa5;text-align:left;">Выгоды:</td>
                                        <td colspan="2"></td>
                                      </tr>
                                      <?php
                                        $analog = new Analog($items['items']);
                                        echo $analog->result();

                                        //echo "<pre>".print_r($items, true)."</pre>";
                                        //exit;
                                      ?>
                                    </table>

                                </td>
                            </tr>



                <!--for video_template-->

</tbody></table>
                </td></tr>

                <?if($items['parameters']['print'] == 0):?>
                <tr>
                    <td style="padding: 25px 20px 10px 20px; background: white;">
                        <p style="margin: 0; padding: 0; font-family: 'Trebuchet MS', sans-serif; font-size: 13px;">Всю подробную информацию по заинтересовавшим Вас моделям техники, а также опыт эксплуатации и отзывы потребителей Вы сможете получить у Вашего персонального менеджера. </p>
                    </td>
                </tr>
                <tr>
                    <td style="padding: 0 20px; background: white;">
                        <table style="border-collapse: collapse;" width="100%" cellspacing="0" cellpadding="0" align="left" bgcolor="#FFFFFF">
                            <tbody>
                                <tr>
                                    <td><span style="font-family: 'Trebuchet MS', sans-serif; font-size: 15px; font-weight: bold;">Ждем Вас в филиале ЛБР-АгроМаркет (<b><?php echo $filial['name']; ?></b>)!</span><br></td>
                                </tr>
                                <tr>
                                    <td><span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;">Время работы: пн.-пт. <?php echo $filial['work_time']; ?></span><br></td>
                                </tr>
                                <tr>
                                    <td><span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;"><?php echo $filial['address']; ?></span><br></td>
                                </tr>
                            <tr>
                                <td style="padding:5px 0px 0px 0px;">
                                    <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;">Горячая линия</span><br>
                                    <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;"><b>8 800 555 32 48</b></span><br>
                                    <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;">Звонок по России бесплатный</span>
                                </td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>
                <tr>
                    <td style="padding: 20px 20px 0px 20px; background: white;">
                        <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 15px; font-weight: bold;">Ваш персональный менеджер<br></span>
                        <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 13px;"><? echo $items['parameters']['user_info']; ?></span>
                    </td>
                </tr>
                <tr>
                    <td style="padding:0px 20px 0px 20px; background: white;">
                        <table style="border-collapse: collapse;" width="255" cellspacing="0" cellpadding="0" align="left" bgcolor="white">
                            <tbody><tr>
                                <td width="150" valign="middle" style="padding:10px 5px 10px 5px">
                                    <span style="font-family: 'Trebuchet MS', sans-serif; font-size: 14px; font-weight: normal;">Мы в соцсетях:</span>
                                </td>
                                <td width="35" style="padding:10px 5px 10px 0px">
                                    <a href="https://vk.com/lbragromarket" target="_blank" style="text-decoration: none;">
                                        <img src="https://www.lbr.ru/images/evp_template/vk.png" width="30" style="border: 0; float: left;" alt="Изображения не отображаются">
                                    </a>
                                </td>
                                <td width="35" style="padding:10px 5px 10px 0px">
                                    <a href="https://www.facebook.com/%D0%9B%D0%91%D0%A0-%D0%90%D0%B3%D1%80%D0%BE%D0%9C%D0%B0%D1%80%D0%BA%D0%B5%D1%82-1412261925531067/" target="_blank" style="text-decoration: none;">
                                        <img src="https://www.lbr.ru/images/evp_template/fb.png" width="30" style="border: 0; float: left;" alt="Изображения не отображаются">
                                    </a>
                                </td>
                                <td width="35" style="padding:10px 5px 10px 0px">
                                    <a href="https://www.youtube.com/user/LBRAgromarket/" target="_blank" style="text-decoration: none;">
                                        <img src="https://www.lbr.ru/images/evp_template/youtube.png" width="30" style="border: 0; float: left;" alt="Изображения не отображаются">
                                    </a>
                                </td>
                                <td width="35">
                                    <a href="https://www.instagram.com/lbragro/" target="_blank" style="text-decoration: none;">
                                        <img src="https://www.lbr.ru/images/evp_template/instagram.png" width="30" style="border: 0; float: left;" alt="Изображения не отображаются">
                                    </a>
                                </td>
                            </tr></tbody>
                        </table>
                    </td>
                </tr>

                <tr>
                    <td style="padding: 20px 20px; background: white;">
                        <p style="margin:0; color: black; padding: 0; font-size: 10px; font-weight: normal; text-align: left; font-family: 'Trebuchet MS', sans-serif;">
                            Данное письмо не является офертой. Цены действительны на момент совершения рассылки. Актуальные цены уточняйте у менеджера Вашего региона.
                        </p>
                    </td>
                </tr>
                <?endif;?>


            </tbody></table>
        </td>
    </tr>
</tbody></table>
</body>
</html>
